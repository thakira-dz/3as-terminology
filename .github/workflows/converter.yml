name: Convert Documents and Create Release

on:
  push:
    branches:
      - main
    paths:
      - 'unit-*/*.md'

jobs:
  convert-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.WORKFLOW_TOKEN }}

      - name: ğŸ”¨ Create new branch
        run: |
          branch_name="docs/update-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $branch_name
          echo "BRANCH_NAME=$branch_name" >> $GITHUB_ENV

      - name: ğŸ§° Install Pandoc, LaTeX, and Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive texlive-xetex texlive-fonts-recommended
          sudo apt-get install -y fonts-arabeyes fonts-kacst

      - name: ğŸ“ Create Arabic Template
        run: |
          cat > arabic-template.docx << EOL
          <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
          <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
            <w:body>
              <w:p>
                <w:pPr>
                  <w:bidi/>
                  <w:rPr>
                    <w:rtl/>
                    <w:rFonts w:ascii="Traditional Arabic" w:hAnsi="Traditional Arabic"/>
                  </w:rPr>
                </w:pPr>
              </w:p>
            </w:body>
          </w:document>
          EOL

      - name: ğŸ›  Convert Markdown to PDF, DOCX, EPUB
        run: |
          mkdir -p converted
          for mdfile in $(find . -type f -path "./unit-*" -name "*.md"); do
            base=$(basename "$mdfile" .md)
            dir=$(dirname "$mdfile" | sed 's|./||;s|/|_|g')
            name="${dir}_${base}"

            echo "Converting $mdfile..."
            pandoc "$mdfile" -o "converted/${name}.pdf" --pdf-engine=xelatex \
              -V mainfont="Traditional Arabic" \
              -V documentclass=article || echo "PDF failed for $mdfile"

            pandoc "$mdfile" -o "converted/${name}.docx" \
              --reference-doc=arabic-template.docx || echo "DOCX failed for $mdfile"

            pandoc "$mdfile" -o "converted/${name}.epub" \
              --direction=rtl || echo "EPUB failed for $mdfile"
          done

      - name: ğŸ“¦ Zip Converted Files
        run: |
          cd converted
          zip -r ../converted-files.zip *
          cd ..

      - name: ğŸ“ Commit converted files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add converted/ converted-files.zip
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ“š convert files into pdf, docx, epub"
          fi

      - name: ğŸ”„ Push branch
        run: |
          git push origin ${{ env.BRANCH_NAME }}

      - name: ğŸ” Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.WORKFLOW_TOKEN }}
          title: "ğŸ“š ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙˆÙ„Ø©"
          body: |
            # ğŸŒŸ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª
            
            Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ØŒ
            
            ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙˆÙ„Ø©:

            ## ğŸ“‹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            - âœ¨ ØªØ­ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Markdown Ø¥Ù„Ù‰ PDF
            - ğŸ“˜ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¥Ù„Ù‰ ØµÙŠØºØ© DOCX
            - ğŸ“± Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø® EPUB Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©

            ## âœ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
            - [ ] Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­ÙˆÙ„Ø©
            - [ ] Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            - [ ] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙØ­Ø§Øª

            ## ğŸ“Œ Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            - ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· Traditional Arabic Ù„Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª
            - ØªÙ… Ø¶Ø¨Ø· Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±
            - Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø¶ØºÙˆØ·Ø© ÙÙŠ Ù…Ù„Ù ZIP Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù‡Ù„
          branch: ${{ env.BRANCH_NAME }}
          base: main
          delete-branch: false

      - name: âœ… Auto-Approve Pull Request
        if: steps.create-pr.outputs.pull-request-number
        uses: hmarr/auto-approve-action@v3
        with:
          pull-request-number: ${{ steps.create-pr.outputs.pull-request-number }}
          github-token: ${{ secrets.WORKFLOW_TOKEN }}

      - name: ğŸ§° Set up GitHub CLI
        uses: cli/cli-action@v2

      - name: ğŸ”„ Merge Pull Request
        if: steps.create-pr.outputs.pull-request-number
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} --merge --delete-branch
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: converted-files.zip
          tag_name: v${{ github.run_number }}
          name: "Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${{ github.run_number }}"
          body: |
            # ğŸ“š Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙˆÙ„Ø©
            
            ÙŠØ­ØªÙˆÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø¹Ù„Ù‰:
            - ğŸ“„ Ù†Ø³Ø® PDF Ù„Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª
            - ğŸ“˜ Ù†Ø³Ø® DOCX Ù„Ù„ØªØ­Ø±ÙŠØ±
            - ğŸ“± Ù†Ø³Ø® EPUB Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
